# 端到端音频转知识库语料系统

博邦方舟无创血糖仪客服对话录音的端到端智能处理系统，将音频文件转换为高质量的知识库语料。

## 🌟 系统概述

本系统将客服对话音频文件（WAV/MP3）自动转换为结构化的知识库语料，采用**Gleaning多轮清洗机制**确保输出高质量内容。

### 处理流程
```
MP3音频 → WAV转换 → 说话人分离 → 切分子音频 → ASR语音识别 → Gleaning多轮清洗 → 高质量语料
```

**Gleaning机制**: 第1轮基础清洗 → 第2轮精细优化 → 第3轮深度完善，质量达标或改进微小时自动停止。

## 🔧 技术架构

### 核心技术栈
- **说话人分离**: `pyannote.audio` - 基于深度学习的说话人分离模型
- **语音识别**: `SenseVoice-Small` - 阿里开源的高精度多语言语音识别模型
- **数据清洗**: `qwen-plus-latest` - 阿里云通义千问最新版LLM
- **音频处理**: `torchaudio` - PyTorch音频处理库
- **GPU加速**: CUDA支持，模型运行在GPU上

### 数据流管道
```
原始录音(.wav/.mp3)
  ↓ 1. 音频转换
WAV音频文件
  ↓ 2. 说话人分离 (pyannote)
RTTM时间戳文件
  ↓ 3. 音频切分 (torchaudio)
按说话人分割的音频片段
  ↓ 4. ASR识别 (SenseVoice)
原始文本对话记录
  ↓ 5. LLM数据清洗 (qwen-plus-latest)
高质量知识库语料
```

## 🚀 快速开始

### 1. 环境配置

#### 依赖安装
```bash
pip install -r requirements.txt
```

#### 环境变量配置
创建 `.env` 文件：
```bash
# Hugging Face 访问令牌 (用于pyannote模型)
HUGGINGFACE_TOKEN=hf_your_token_here

# 阿里云API配置 (用于LLM清洗功能)
DASHSCOPE_API_KEY=sk-your_api_key_here
DASHSCOPE_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

### 2. 使用方法

#### 一键运行
```bash
# 完整的端到端处理
python main.py
```

#### 分步处理
```python
from processor import AudioProcessor

# 创建处理器
processor = AudioProcessor()

# 批量处理（包含MP3转WAV预处理）
processor.process_batch()

# 处理单个文件
processor.process_single_file("wavs/audio1.wav")
```

### 3. 目录结构
```
.
├── mp3s/                      # 原始MP3音频文件
├── wavs/                      # WAV格式音频文件
├── rttms/                     # 说话人分离结果文件
├── docs/                      # 最终清洗后的语料文件
├── senseVoice-small/          # 本地SenseVoice模型
├── main.py                    # 主程序入口
├── processor.py               # 音频处理器
├── llm_cleaner.py            # LLM数据清洗模块
└── requirements.txt           # 依赖包列表
```

## 🔄 Gleaning多轮清洗机制

### 核心特性（默认启用）
- **迭代优化**: 第1轮基础清洗 → 第2轮精细优化 → 第3轮深度完善
- **智能停止**: 质量达标或改进微小时自动停止，避免过度处理
- **质量评估**: 每轮自动评估流畅度、专业度、完整度、准确度、逻辑性
- **最优选择**: 自动选择质量最高的轮次作为最终结果

### 智能数据清洗
- **产品术语修正**: 自动识别和修正"无川血糖仪"→"无创血糖仪"等识别错误
- **噪音过滤**: 去除背景电视、音乐等与客服无关的干扰内容
- **语言修正**: 修正中文语气词被误识别为日文的问题
- **对话还原**: 基于博邦方舟无创血糖仪客服场景还原真实对话

### 文件组织
- **输入**: 各处理步骤的中间结果
- **输出**: 直接覆盖 `docs/` 目录中的原始ASR文件
- **处理方式**: Gleaning多轮清洗后的高质量内容替换原始ASR结果

## 📊 质量保证

### 数据清洗规则
针对博邦方舟无创血糖仪客服对话的专业清洗：

1. **产品名称修正**
   - "银行五创检查仪" → "无创血糖仪"
   - "无川血糖仪" → "无创血糖仪"
   - "博帮方舟" → "博邦方舟"

2. **语言错误修正**
   - 日文误识别 "それ" → 删除或还原为中文语气词
   - 语气词还原 "额"、"嗯" 等

3. **噪音内容过滤**
   - 删除电视声音、音乐内容
   - 过滤与血糖仪无关的对话
   - 移除重复、无意义的语句

4. **质量原则**
   - 不编造任何事实
   - 不确定的内容标注为"[不清楚]"
   - 保持专业客服对话的完整性

### 质量指标
- 产品术语准确率 > 95%
- 噪音过滤效果 > 90%
- 对话完整性保持 > 98%
- 事实准确性 100% (不编造内容)
- Gleaning质量评分 > 0.8

## 🔧 配置选项

### 系统配置
- **默认模式**: 自动启用Gleaning多轮清洗
- **输出位置**: 所有清洗结果直接覆盖`docs/`目录中的原始ASR文件
- **质量控制**: 默认3轮清洗，质量阈值0.9，自动停止机制

### 高级配置（可选）
```python
# 修改默认参数
processor.max_gleaning_rounds = 4      # 最大清洗轮数
processor.enable_gleaning = True       # 默认启用

# 质量阈值在LLMDataCleaner中配置(默认0.9)
# 如需修改，请编辑llm_cleaner.py:49行

# 强制重新处理
processor.process_batch(force_overwrite=True)
```

## 📈 监控统计

### Token使用统计
```
📊 Token使用情况:
   - 输入tokens: 1234
   - 输出tokens: 567
   - 总计tokens: 1801
```

### 处理进度显示
```
🔄 使用Gleaning多轮清洗...
✨ Gleaning清洗完成: 3轮, 1801 tokens, 质量评分: 0.85
```

### 批量处理统计
```
🎉 批量清洗完成！
✅ 成功: 5 个文件
❌ 失败: 0 个文件
📊 总计使用: 9127 tokens
```

## 🛠️ 技术特性

### 智能文件排序
- 提取文件名中的序号进行排序
- 格式: `000_SPEAKER_01-0.031-1.398.wav`
- 确保对话的时间顺序正确性

### 说话人信息提取
- 从文件名自动提取说话人ID
- 支持SPEAKER_00, SPEAKER_01等格式
- 容错处理：未识别时标记为UNKNOWN_SPEAKER

### 批量处理优化
- 支持跳过已处理的文件
- 完整的进度监控和状态报告
- 内存优化的流式处理

## 🚨 错误处理

### 常见问题及解决方案

1. **环境变量未配置**
   ```
   错误: 请在.env文件中配置DASHSCOPE_API_KEY和DASHSCOPE_BASE_URL
   解决: 检查.env文件配置
   ```

2. **依赖包未安装**
   ```
   警告: openai包未安装，请运行 pip install openai
   解决: pip install openai python-dotenv
   ```

3. **API调用失败**
   ```
   ❌ LLM清洗失败: API调用错误
   解决: 检查API密钥和网络连接
   ```

### 容错机制
- LLM清洗失败时，系统继续运行，不影响前面的ASR结果
- 提供详细的错误信息和解决建议
- 支持跳过LLM清洗，仅使用原始ASR结果

## 🎯 使用场景

- **客服对话分析**: 客服质量评估和话术优化
- **知识库构建**: 基于真实对话构建FAQ和知识库
- **AI训练数据**: 为对话AI模型提供高质量训练语料
- **业务洞察**: 了解客户关注点和常见问题

## 📝 更新日志

### v2.0.0 (2024-12-20)
- ✅ 实现Gleaning多轮清洗机制（默认启用）
- ✅ 统一输出到docs目录，简化文件管理
- ✅ 5维质量评估和智能停止机制
- ✅ 针对博邦方舟无创血糖仪的专业清洗规则
- ✅ 简化配置和使用流程

## 🤝 技术支持

如遇问题，请检查：
1. 环境变量配置是否正确
2. 依赖包是否安装完整
3. API密钥是否有效
4. 网络连接是否正常

---

**系统特色**: 端到端自动化、Gleaning多轮清洗、GPU加速、智能质量控制